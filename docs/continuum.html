<!DOCTYPE html>  <html> <head>   <title>continuum.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="bokeh.html">                 bokeh.coffee               </a>                                           <a class="source" href="coffee_style_guide.html">                 coffee_style_guide.coffee               </a>                                           <a class="source" href="continuum.html">                 continuum.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               continuum.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>module setup stuff</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">Continuum</span>
  <span class="nv">Continuum = </span><span class="k">this</span><span class="p">.</span><span class="nx">Continuum</span>
<span class="k">else</span>
  <span class="nv">Continuum = </span><span class="p">{}</span>
  <span class="k">this</span><span class="p">.</span><span class="nv">Continuum = </span><span class="nx">Continuum</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>we create a dictionary of collections, for all types that we know,
we use these when models are pushed down from the server</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Continuum</span><span class="p">.</span><span class="nx">Collection</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>at some point, I thought we needed to override create... we don't anymore...
can switch back to Backbone.Collection later</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Collections = </span><span class="p">{}</span>
<span class="nv">Continuum.Collections = </span><span class="nx">Collections</span>
<span class="nv">Continuum.register_collection = </span><span class="nf">(key, value) -&gt;</span>
  <span class="nx">Collections</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
  <span class="nv">value.bokeh_key = </span><span class="nx">key</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>continuum refrence system
  reference : {'type' : type name, 'id' : object id}
  each class has a collections class var, and type class var.
  references are resolved by looking up collections[type]
  to get a collection
  and then retrieving the correct id.  The one exception is that an object
  can resolve a reference to itself even if it has not yet been added to
  any collections.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>backbone note - we're sort of using defaults in the code to tell the user
what attributes are expected, so please specify defaults for
all attributes you plan on usign</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Continuum.load_models = </span><span class="nf">(modelspecs)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>function : load models.</h2>

<p>First we identify which model specs correspond to new models,
and which ones are updates.  For new models we instantiate the models, add them
to their collections and call dinitialize.  For existing models we update
their attributes</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h4>Parameters</h4>

<ul>
<li>modelspecs : list of models in json form, looking like this</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <pre><code>    type : 'Plot'
    collections : ['Continuum', 'Collections']
    id : '2390-23-23'
    attributes:
    name : 'myplot'
    renderers : []
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>collections tells us where to find the dictionary of collections used to
  construct the model
  type is the key of the in collections for this model
  id is the id of this model
  attributes are the attributes of the model</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h4>Returns</h4>

<ul>
<li>null</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">newspecs = </span><span class="p">[]</span>
  <span class="nv">oldspecs = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">model</span> <span class="k">in</span> <span class="nx">modelspecs</span>
    <span class="nv">coll = </span><span class="nx">get_collections</span><span class="p">(</span><span class="nx">model</span><span class="p">[</span><span class="s1">&#39;collections&#39;</span><span class="p">])[</span><span class="nx">model</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]]</span>
    <span class="nv">attrs = </span><span class="nx">model</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">attrs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
      <span class="nx">oldspecs</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">coll</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">])</span>
    <span class="k">else</span>
      <span class="nx">newspecs</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">coll</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">])</span>
  <span class="k">for</span> <span class="nx">coll_attrs</span> <span class="k">in</span> <span class="nx">newspecs</span>
    <span class="p">[</span><span class="nx">coll</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">]</span> <span class="o">=</span> <span class="nx">coll_attrs</span>
    <span class="nx">coll</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">coll_attrs</span> <span class="k">in</span> <span class="nx">newspecs</span>
    <span class="p">[</span><span class="nx">coll</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">]</span> <span class="o">=</span> <span class="nx">coll_attrs</span>
    <span class="nx">coll</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">attrs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]).</span><span class="nx">dinitialize</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">coll_attrs</span> <span class="k">in</span> <span class="nx">oldspecs</span>
    <span class="p">[</span><span class="nx">coll</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">]</span> <span class="o">=</span> <span class="nx">coll_attrs</span>
    <span class="nx">coll</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">attrs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]).</span><span class="nx">set</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;local&#39;</span> <span class="o">:</span> <span class="kc">true</span><span class="p">})</span>
  <span class="k">return</span> <span class="kc">null</span>

<span class="nv">Continuum.submodels = </span><span class="nf">(ws_conn_string, topic) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>function : Continuum.submodels</h2>

<p>creates a websocket which subscribes and listens for model changes</p>

<h5>Parameters</h5>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <ul>
<li>ws<em>conn</em>string : path of the web socket to subscribe</li>
<li>topic : topic to listen on (send to the server on connect)</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h5>Returns</h5>

<ul>
<li>the websocket</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">try</span>
    <span class="nv">s = </span><span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">ws_conn_string</span><span class="p">)</span>
  <span class="k">catch</span> <span class="nx">error</span>
    <span class="nv">s = </span><span class="k">new</span> <span class="nx">MozWebSocket</span><span class="p">(</span><span class="nx">ws_conn_string</span><span class="p">)</span>
  <span class="nv">s.onopen = </span><span class="nf">() -&gt;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nv">msgtype : </span><span class="s1">&#39;subscribe&#39;</span><span class="p">,</span> <span class="nv">topic : </span><span class="nx">topic</span><span class="p">}))</span>
  <span class="nv">s.onmessage = </span><span class="nf">(msg) -&gt;</span>
    <span class="nv">msgobj = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">msgobj</span><span class="p">[</span><span class="s1">&#39;msgtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;modelpush&#39;</span>
      <span class="nx">Continuum</span><span class="p">.</span><span class="nx">load_models</span><span class="p">(</span><span class="nx">msgobj</span><span class="p">[</span><span class="s1">&#39;modelspecs&#39;</span><span class="p">])</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">msgobj</span><span class="p">[</span><span class="s1">&#39;msgtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;modeldel&#39;</span>
      <span class="k">for</span> <span class="nx">ref</span> <span class="k">in</span> <span class="nx">msgobj</span><span class="p">[</span><span class="s1">&#39;modelspecs&#39;</span><span class="p">]</span>
        <span class="nv">model = </span><span class="nx">Continuum</span><span class="p">.</span><span class="nx">resolve_ref</span><span class="p">(</span><span class="nx">ref</span><span class="p">[</span><span class="s1">&#39;collections&#39;</span><span class="p">],</span> <span class="nx">ref</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="nx">ref</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nx">model</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">destroy</span><span class="p">({</span><span class="s1">&#39;local&#39;</span> <span class="o">:</span> <span class="kc">true</span><span class="p">})</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">msgobj</span><span class="p">[</span><span class="s1">&#39;msgtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;status&#39;</span> <span class="o">and</span>
      <span class="nx">msgobj</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;subscribesuccess&#39;</span>
        <span class="nv">clientid = </span><span class="nx">msgobj</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="nv">Continuum.clientid = </span><span class="nx">clientid</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">({</span><span class="s1">&#39;headers&#39;</span> <span class="o">:</span> <span class="p">{</span><span class="s1">&#39;Continuum-Clientid&#39;</span> <span class="o">:</span> <span class="nx">clientid</span><span class="p">}})</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="k">return</span> <span class="nx">s</span>

<span class="nv">build_views = </span><span class="p">(</span><span class="nx">mainmodel</span><span class="p">,</span> <span class="nx">view_storage</span><span class="p">,</span> <span class="nx">view_specs</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h2>function : build_views</h2>

<p>convenience function for creating a bunch of views from a spec
and storing them in a dictionary keyed off of model id.
views are automatically passed the model that they represent</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h4>Parameters</h4>

<ul>
<li>mainmodel : model which is constructing the views, this is used to resolve
specs into other model objects</li>
<li>view_storage : where you want the new views stored.  this is a dictionary
views will be keyed by the id of the underlying model</li>
<li>view_specs : list of view specs.  view specs are continuum references, with
a typename and an id.  you can also pass options you want to feed into
the views constructor here, as an 'options' field in the dict</li>
<li>options : any additional option to be used in the construction of views</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">created_views = </span><span class="p">[]</span>
  <span class="nv">valid_viewmodels = </span><span class="p">{}</span>
  <span class="k">for</span> <span class="nx">spec</span> <span class="k">in</span> <span class="nx">view_specs</span>
    <span class="nx">valid_viewmodels</span><span class="p">[</span><span class="nx">spec</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="k">for</span> <span class="nx">spec</span> <span class="k">in</span> <span class="nx">view_specs</span>
    <span class="k">if</span> <span class="nx">view_storage</span><span class="p">[</span><span class="nx">spec</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
      <span class="k">continue</span>
    <span class="nv">model = </span><span class="nx">mainmodel</span><span class="p">.</span><span class="nx">resolve_ref</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span>
    <span class="nv">options = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span> <span class="o">:</span> <span class="nx">model</span><span class="p">})</span>
    <span class="nx">view_storage</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">model</span><span class="p">.</span><span class="nx">default_view</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
    <span class="nx">created_views</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">view_storage</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">])</span>
  <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">view_storage</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">valid_viewmodels</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="nx">value</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>
      <span class="k">delete</span> <span class="nx">view_storage</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
  <span class="k">return</span> <span class="nx">created_views</span>

<span class="nv">Continuum.build_views = </span><span class="nx">build_views</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>garbage logging experiment that I should remove</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nv">logger = </span><span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">()</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
  <span class="nf">()-&gt;</span>
    <span class="nv">msg = </span><span class="s1">&#39;LOGGER:&#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">))</span>
<span class="nv">Continuum.logger = </span><span class="nb">window</span><span class="p">.</span><span class="nx">logger</span>
<span class="nv">logger = </span><span class="nx">Continuum</span><span class="p">.</span><span class="nx">logger</span>
<span class="nv">logger.log = </span><span class="nf">() -&gt;</span>
  <span class="nx">logger</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;LOG&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>



<span class="nv">get_collections = </span><span class="nf">(names) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2>function : get_collections</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>finds a group of collections, at the location specified by names</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h4>Parameters</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <ul>
<li>names : list of strings - we start at the global name spaces and descend
through each string.  the last value should refer to the group of
collections you want</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h4>Returns</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <ul>
<li>collections</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">last = </span><span class="nb">window</span>
  <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">names</span>
    <span class="nv">last = </span><span class="nx">last</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span>
  <span class="k">return</span> <span class="nx">last</span>

<span class="nv">resolve_ref = </span><span class="nf">(collections, type, id) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h2>funcion : resolve_ref</h2>

<p>Takes a group of collections, type and id, and returns the backbone model
which corresponds</p>

<h4>Parameters</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <ul>
<li>collections : group of collections (as a dict),
the collection for type should
be present here.  Alternatively, one can specify this as an array of strings,
in which case we descend through the global namespace looking for this, using
get_collections.</li>
<li>type : type of the object</li>
<li>id : id of the object</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h4>Returns</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <ul>
<li>backbone model</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">collections</span><span class="p">)</span>
    <span class="nv">collections = </span><span class="nx">get_collections</span><span class="p">(</span><span class="nx">collections</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">collections</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="nv">Continuum.resolve_ref = </span><span class="nx">resolve_ref</span>
<span class="nv">Continuum.get_collections = </span><span class="nx">get_collections</span>

<span class="nv">safebind = </span><span class="nf">(binder, target, event, callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h2>function : safebind</h2>

<p>safebind, binder binds to an event on target, which triggers callback.
Safe means that when the binder is destroyed, all callbacks are unbound.
callbacks are bound and evaluated in the context of binder</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h4>Parameters</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <ul>
<li>binder : some backbone model - when this is destroyed, the callback will be
unbound</li>
<li>target : object triggering the event we want to bind to</li>
<li>event : string, name of the event</li>
<li>callback : callback for the event</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h4>Returns</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <ul>
<li>null</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>stores objects we are binding events on, so that if we go away,
we can unbind all our events
currently, we require that the context being used is the binders context
this is because we currently unbind on a per context basis.  this can
be changed later if we need it</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">binder</span><span class="p">,</span> <span class="s1">&#39;eventers&#39;</span><span class="p">)</span>
    <span class="nx">binder</span><span class="p">[</span><span class="s1">&#39;eventers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nx">binder</span><span class="p">[</span><span class="s1">&#39;eventers&#39;</span><span class="p">][</span><span class="nx">target</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">target</span>
  <span class="nx">target</span><span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">binder</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>also need to bind destroy to remove obj from eventers.
no special logic needed to manage this life cycle, because
we will already unbind all listeners on target when binder goes away</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">target</span><span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="s1">&#39;destroy remove&#39;</span><span class="p">,</span>
      <span class="p">()</span> <span class="o">=&gt;</span>
        <span class="k">delete</span> <span class="nx">binder</span><span class="p">[</span><span class="s1">&#39;eventers&#39;</span><span class="p">][</span><span class="nx">target</span><span class="p">]</span>
    <span class="p">,</span>
      <span class="nx">binder</span><span class="p">)</span>
  <span class="k">return</span> <span class="kc">null</span>

<span class="k">class</span> <span class="nx">HasProperties</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h2>class : HasProperties</h2>

<p>Our property system
  we support python style computed properties, with getters as well as setters.
  we also support caching of these properties, and notifications of property
  changes</p>

<p>@register<em>property(name, dependencies, getter, use</em>cache, setter)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">collections : </span><span class="nx">Collections</span>
  <span class="nv">destroy : </span><span class="nf">(options)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>calls super, also unbinds any events bound by safebind</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">super</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;eventers&#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="nx">own</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">@eventers</span>
        <span class="nx">val</span><span class="p">.</span><span class="kc">off</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>

  <span class="nv">isNew : </span><span class="nf">() -&gt;</span>
    <span class="k">return</span> <span class="o">not</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">)</span>

  <span class="nv">initialize : </span><span class="nf">(attrs, options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>auto generates ids if we need to, calls deferred initialize if we have
not done so already.   sets up datastructures for computed properties</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">super</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="vi">@properties = </span><span class="p">{}</span>
    <span class="vi">@property_cache = </span><span class="p">{}</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nv">id = </span><span class="nx">_</span><span class="p">.</span><span class="nx">uniqueId</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span><span class="p">(()</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">@inited</span>
        <span class="nx">@dinitialize</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">))</span>

  <span class="nv">dinitialize : </span><span class="nf">(attrs, options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>deferred initialization - this is important so we can separate object
creation from object initialization.  We need this if we receive a group
of objects, that need to bind events to each other.  Then we create them all
first, and then call deferred intialization so they can setup dependencies
on each other</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@inited = </span><span class="kc">true</span>

  <span class="nv">set : </span><span class="nf">(key, value, options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>checks for setters, if setters are present, call setters first
then remove the computed property from the dict of attrs, and call super</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>backbones set function supports 2 call signatures, either a dictionary of
key value pairs, and then options, or one key, one value, and then options.
replicating that logic here</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">or</span> <span class="nx">key</span> <span class="o">==</span> <span class="kc">null</span>
      <span class="nv">attrs = </span><span class="nx">key</span>
      <span class="nv">options = </span><span class="nx">value</span>
    <span class="k">else</span>
      <span class="nv">attrs = </span><span class="p">{}</span>
      <span class="nx">attrs</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="nv">toremove  = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">attrs</span>
      <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;properties&#39;</span><span class="p">)</span> <span class="o">and</span>
         <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">@properties</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">and</span>
         <span class="nx">@properties</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="s1">&#39;setter&#39;</span><span class="p">]</span>
        <span class="nx">@properties</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="s1">&#39;setter&#39;</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span>
        <span class="nx">toremove</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">toremove</span>
      <span class="k">delete</span> <span class="nx">attrs</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span>
      <span class="k">super</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>

  <span class="nv">structure_dependencies : </span><span class="nf">(dependencies) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h3>method : HasProperties::structure_dependencies</h3>

<h4>Parameters</h4>

<ul>
<li>dependencies : our structure for specing out
dependencies of properties look like this
<code>[{'ref' : {'type' : type, 'id' : id}, 'fields : ['a', 'b', 'c']}]</code>
for convenience, we allow people to refer to this objects attributes
as strings, only using the formal structure for other objets attributes.
this function converts everything into that formal structure.
SO this :</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <pre><code>  ['myprop1, 'myprop2',
  {'ref' : {'type' : 'otherobj', 'id' : 'otherobj'},
   'fields' : 'otherfield'}]
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>is equivalent to :</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <pre><code>  [{'ref' : {'type' : 'mytype', 'id' : 'myid'},
  'fields' : ['myprop1, 'myprop2'],
  {'ref' : {'type' : 'otherobj', 'id' : 'otherobj'}
  'fields' : 'otherfield'}]
</code></pre>

<h4>Returns</h4>

<ul>
<li>deps : the verbose form of dependencies where references are explicitly
identified</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">other_deps = </span><span class="p">(</span><span class="nx">x</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">dependencies</span> <span class="k">when</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span>
    <span class="nv">local_deps = </span><span class="p">(</span><span class="nx">x</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">dependencies</span> <span class="k">when</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">local_deps</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">deps = </span><span class="p">[{</span><span class="s1">&#39;ref&#39;</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">ref</span><span class="p">(),</span> <span class="s1">&#39;fields&#39;</span> <span class="o">:</span> <span class="nx">local_deps</span><span class="p">}]</span>
      <span class="nv">deps = </span><span class="nx">deps</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">other_deps</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">deps = </span><span class="nx">other_deps</span>
    <span class="k">return</span> <span class="nx">deps</span>

  <span class="nv">register_property : </span><span class="o">\</span>
    <span class="nf">(prop_name, dependencies, getter, use_cache, setter) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <h3>method : HasProperties::register_property</h3>

<p>register a computed property</p>

<h4>Parameters</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <ul>
<li>prop_name : name of property</li>
<li>dependencies : something like this
['myprop1, 'myprop2',
{'ref' : {'type' : 'otherobj', 'id' : 'otherobj'}
'fields' : 'otherfield'}]</li>
<li>getter : function, calculates computed value, takes no arguments</li>
<li>use_cache : whether to cache or not</li>
<li>setter : function, takes new value as parametercalled on set.
can be null</li>
</ul>

<h4>Returns</h4>

<ul>
<li>prop_spec : specification of the property, with the getter,
setter, dependenices, and callbacks associated with the prop</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">@properties</span><span class="p">,</span> <span class="nx">prop_name</span><span class="p">)</span>
        <span class="nx">@remove_property</span><span class="p">(</span><span class="nx">prop_name</span><span class="p">)</span>
      <span class="nv">dependencies = </span><span class="nx">@structure_dependencies</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>we store a prop_spec, which has the getter, setter, dependencies
we also store the callbacks used to implement the computed property,
we do this so we can remove them later if the property is removed</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">prop_spec=</span>
        <span class="s1">&#39;getter&#39;</span> <span class="o">:</span> <span class="nx">getter</span><span class="p">,</span>
        <span class="s1">&#39;dependencies&#39;</span> <span class="o">:</span> <span class="nx">dependencies</span><span class="p">,</span>
        <span class="s1">&#39;use_cache&#39;</span> <span class="o">:</span> <span class="nx">use_cache</span>
        <span class="s1">&#39;setter&#39;</span> <span class="o">:</span> <span class="nx">setter</span>
        <span class="s1">&#39;callbacks&#39;</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>we call this changedep call back when any of our dependecies
are changed</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="s1">&#39;changedep&#39;</span> <span class="o">:</span> <span class="o">=&gt;</span>
            <span class="nx">@trigger</span><span class="p">(</span><span class="s1">&#39;changedep:&#39;</span> <span class="o">+</span> <span class="nx">prop_name</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>we call propchange when we receive a changedep event for this prop</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="s1">&#39;propchange&#39;</span> <span class="o">:</span> <span class="o">=&gt;</span>
            <span class="nv">firechange = </span><span class="kc">true</span>
            <span class="k">if</span> <span class="nx">prop_spec</span><span class="p">[</span><span class="s1">&#39;use_cache&#39;</span><span class="p">]</span>
              <span class="nv">old_val = </span><span class="nx">@get_cache</span><span class="p">(</span><span class="nx">prop_name</span><span class="p">)</span>
              <span class="nx">@clear_cache</span><span class="p">(</span><span class="nx">prop_name</span><span class="p">)</span>
              <span class="nv">new_val = </span><span class="nx">@get</span><span class="p">(</span><span class="nx">prop_name</span><span class="p">)</span>
              <span class="nv">firechange = </span><span class="nx">new_val</span> <span class="o">!=</span> <span class="nx">old_val</span>
            <span class="k">if</span> <span class="nx">firechange</span>
              <span class="nx">@trigger</span><span class="p">(</span><span class="s1">&#39;change:&#39;</span> <span class="o">+</span> <span class="nx">prop_name</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@get</span><span class="p">(</span><span class="nx">prop_name</span><span class="p">))</span>
              <span class="nx">@trigger</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
      <span class="nx">@properties</span><span class="p">[</span><span class="nx">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">prop_spec</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>bind depdencies to change dep callback</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">dep</span> <span class="k">in</span> <span class="nx">dependencies</span>
        <span class="nv">obj = </span><span class="nx">@resolve_ref</span><span class="p">(</span><span class="nx">dep</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="nx">fld</span> <span class="k">in</span> <span class="nx">dep</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span>
          <span class="nx">safebind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="s2">&quot;change:&quot;</span> <span class="o">+</span> <span class="nx">fld</span><span class="p">,</span> <span class="nx">prop_spec</span><span class="p">[</span><span class="s1">&#39;callbacks&#39;</span><span class="p">][</span><span class="s1">&#39;changedep&#39;</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>bind propchange callback to change dep event</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">safebind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s2">&quot;changedep:&quot;</span> <span class="o">+</span> <span class="nx">prop_name</span><span class="p">,</span>
        <span class="nx">prop_spec</span><span class="p">[</span><span class="s1">&#39;callbacks&#39;</span><span class="p">][</span><span class="s1">&#39;propchange&#39;</span><span class="p">])</span>
      <span class="k">return</span> <span class="nx">prop_spec</span>

  <span class="nv">remove_property : </span><span class="nf">(prop_name) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>removes the property, unbinding all associated callbacks that implemented it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">prop_spec = </span><span class="nx">@properties</span><span class="p">[</span><span class="nx">prop_name</span><span class="p">]</span>
    <span class="nv">dependencies = </span><span class="nx">prop_spec</span><span class="p">.</span><span class="nx">dependencies</span>
    <span class="k">for</span> <span class="nx">dep</span> <span class="k">in</span> <span class="nx">dependencies</span>
      <span class="nv">obj = </span><span class="nx">@resolve_ref</span><span class="p">(</span><span class="nx">dep</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">])</span>
      <span class="k">for</span> <span class="nx">fld</span> <span class="k">in</span> <span class="nx">dep</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span>
        <span class="nx">obj</span><span class="p">.</span><span class="kc">off</span><span class="p">(</span><span class="s1">&#39;change:&#39;</span> <span class="o">+</span> <span class="nx">fld</span><span class="p">,</span> <span class="nx">prop_spec</span><span class="p">[</span><span class="s1">&#39;callbacks&#39;</span><span class="p">][</span><span class="s1">&#39;changedep&#39;</span><span class="p">],</span> <span class="k">this</span><span class="p">)</span>
    <span class="nx">@off</span><span class="p">(</span><span class="s2">&quot;changedep:&quot;</span> <span class="o">+</span> <span class="nx">dep</span><span class="p">)</span>
    <span class="k">delete</span> <span class="nx">@properties</span><span class="p">[</span><span class="nx">prop_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">prop_spec</span><span class="p">.</span><span class="nx">use_cache</span>
      <span class="nx">@clear_cache</span><span class="p">(</span><span class="nx">prop_name</span><span class="p">)</span>

  <span class="nv">has_cache : </span><span class="nf">(prop_name) -&gt;</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">@property_cache</span><span class="p">,</span> <span class="nx">prop_name</span><span class="p">)</span>

  <span class="nv">add_cache : </span><span class="nf">(prop_name, val) -&gt;</span>
    <span class="nx">@property_cache</span><span class="p">[</span><span class="nx">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>

  <span class="nv">clear_cache : </span><span class="nf">(prop_name, val) -&gt;</span>
    <span class="k">delete</span> <span class="nx">@property_cache</span><span class="p">[</span><span class="nx">prop_name</span><span class="p">]</span>

  <span class="nv">get_cache : </span><span class="nf">(prop_name) -&gt;</span>
    <span class="k">return</span> <span class="nx">@property_cache</span><span class="p">[</span><span class="nx">prop_name</span><span class="p">]</span>

  <span class="nv">get : </span><span class="nf">(prop_name) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <h3>method : HasProperties::get</h3>

<p>overrides backbone get.  checks properties, calls getter, or goes to cache
if necessary.  If it's not a property, then just call super</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">@properties</span><span class="p">,</span> <span class="nx">prop_name</span><span class="p">)</span>
      <span class="nv">prop_spec = </span><span class="nx">@properties</span><span class="p">[</span><span class="nx">prop_name</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">prop_spec</span><span class="p">.</span><span class="nx">use_cache</span> <span class="o">and</span> <span class="nx">@has_cache</span><span class="p">(</span><span class="nx">prop_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">@property_cache</span><span class="p">[</span><span class="nx">prop_name</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="nv">getter = </span><span class="nx">prop_spec</span><span class="p">.</span><span class="nx">getter</span>
        <span class="nv">computed = </span><span class="nx">getter</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">@properties</span><span class="p">[</span><span class="nx">prop_name</span><span class="p">].</span><span class="nx">use_cache</span>
          <span class="nx">@add_cache</span><span class="p">(</span><span class="nx">prop_name</span><span class="p">,</span> <span class="nx">computed</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">computed</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="k">super</span><span class="p">(</span><span class="nx">prop_name</span><span class="p">)</span>

  <span class="nv">ref : </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <h3>method : HasProperties::ref</h3>

<p>generates a reference to this model</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;type&#39;</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span>
    <span class="s1">&#39;id&#39;</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span>

  <span class="nv">resolve_ref : </span><span class="nf">(ref) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h3>method : HasProperties::resolve_ref</h3>

<p>converts a reference into an object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">ref</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ERROR, null reference&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>this way we can reference ourselves
even though we are not in any collection yet</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">ref</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">and</span> <span class="nx">ref</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span>
      <span class="k">return</span> <span class="k">this</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="nx">resolve_ref</span><span class="p">(</span><span class="nx">@collections</span><span class="p">,</span> <span class="nx">ref</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="nx">ref</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

  <span class="nv">get_ref : </span><span class="nf">(ref_name) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <h3>method : HasProperties::get_ref</h3>

<p>convenience function, gets the backbone attribute ref_name, which is assumed
to be a reference, then resolves the reference and returns the model</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ref = </span><span class="nx">@get</span><span class="p">(</span><span class="nx">ref_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">ref</span>
      <span class="k">return</span> <span class="nx">@resolve_ref</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span>

  <span class="nv">url : </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <h3>method HasProperties::url</h3>

<p>model where our API processes this model</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">base = </span><span class="s2">&quot;/bb/&quot;</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">topic</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">@type</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">@isNew</span><span class="p">())</span>
      <span class="k">return</span> <span class="nx">base</span>
    <span class="k">return</span> <span class="nx">base</span> <span class="o">+</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

  <span class="nv">sync : </span><span class="nf">(method, model, options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>override sync, so that if we pass in a 'local' option,
we don't involve the server.  This is necessary, ex.  Object is created on
the server, pushed down.  you want to create it locally, but you don't want
the client to try to make an API call to create this on the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">local</span>
      <span class="k">return</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
  <span class="nv">defaults :</span>
    <span class="nv">docs : </span><span class="p">[</span><span class="nb">window</span><span class="p">.</span><span class="nx">topic</span><span class="p">]</span>

<span class="k">class</span> <span class="nx">ContinuumView</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span>
  <span class="nv">initialize : </span><span class="nf">(options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>autogenerates id</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nv">id = </span><span class="nx">_</span><span class="p">.</span><span class="nx">uniqueId</span><span class="p">(</span><span class="s1">&#39;ContinuumView&#39;</span><span class="p">)</span>
  <span class="nv">remove : </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>handles lifecycle of events bound by safebind</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;eventers&#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="nx">own</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">@eventers</span>
        <span class="nx">val</span><span class="p">.</span><span class="kc">off</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
    <span class="nx">@trigger</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">)</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">tag_selector : </span><span class="nf">(tag, id) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>jquery style selector given a string, and an id.
We name DOM nodes using this convention</p>

<div id='name-2342342'>hugo</div>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">@tag_id</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>

  <span class="nv">tag_id : </span><span class="nf">(tag, id) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>convention for naming our nodes, tag-id. if ID is not specified,
we use the id of the current view.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">id</span>
      <span class="nv">id = </span><span class="k">this</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">tag</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">id</span>

  <span class="nv">tag_el : </span><span class="nf">(tag, id) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>returns jquery node matching this tag/id combo</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">tag_id</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">id</span><span class="p">))</span>
  <span class="nv">tag_d3 : </span><span class="nf">(tag, id) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>returns d3 node matching this tag/id combo.  null if it does not exist</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">val = </span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">tag_id</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">id</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">val</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span>
      <span class="k">return</span> <span class="kc">null</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="nx">val</span>
  <span class="nv">mget : </span><span class="nf">()-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>convenience function, calls get on the associated model</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@model</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>

  <span class="nv">mset : </span><span class="nf">()-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>convenience function, calls set on the associated model</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@model</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>

  <span class="nv">mget_ref : </span><span class="nf">(fld) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>convenience function, calls get_ref on the associated model</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">get_ref</span><span class="p">(</span><span class="nx">fld</span><span class="p">)</span>

  <span class="nv">add_dialog : </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>wraps a dialog window around this view.  This function assumes that the
underlying model is a Component, so our OO hierarchy may be a bit leaky here.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">position = </span><span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">dialog</span><span class="p">(</span><span class="s1">&#39;widget&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span>
        <span class="s1">&#39;top&#39;</span> <span class="o">:</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">position_y</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">,</span>
        <span class="s1">&#39;left&#39;</span> <span class="o">:</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">position_x</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span>
      <span class="p">})</span>
    <span class="nx">@$el</span><span class="p">.</span><span class="nx">dialog</span><span class="p">(</span>
      <span class="nv">width : </span><span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;outerwidth&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">50</span><span class="p">,</span>
      <span class="nv">maxHeight : </span><span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">(),</span>
      <span class="nv">close : </span> <span class="p">()</span> <span class="o">=&gt;</span>
        <span class="nx">@remove</span><span class="p">()</span>
      <span class="nv">dragStop : </span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">ui</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">top = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">@$el</span><span class="p">.</span><span class="nx">dialog</span><span class="p">(</span><span class="s1">&#39;widget&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;px&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nv">left = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">@$el</span><span class="p">.</span><span class="nx">dialog</span><span class="p">(</span><span class="s1">&#39;widget&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;px&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nv">xoff = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">reverse_position_x</span><span class="p">(</span><span class="nx">left</span><span class="p">);</span>
        <span class="nv">yoff = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">reverse_position_y</span><span class="p">(</span><span class="nx">top</span><span class="p">);</span>
        <span class="nx">@model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="s1">&#39;offset&#39;</span> <span class="o">:</span> <span class="p">[</span><span class="nx">xoff</span><span class="p">,</span> <span class="nx">yoff</span><span class="p">]})</span>
        <span class="nx">@model</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="nx">position</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>for some reason setting height at init time does not work!!</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">@$el</span><span class="p">.</span><span class="nx">dialog</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;outerheight&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">70</span><span class="p">))</span>
    <span class="nx">safebind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@model</span><span class="p">,</span> <span class="s1">&#39;change:offset&#39;</span><span class="p">,</span> <span class="nx">position</span><span class="p">)</span>
    <span class="nx">safebind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@model</span><span class="p">,</span> <span class="s1">&#39;change:outerwidth&#39;</span><span class="p">,</span> <span class="nf">()-&gt;</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">dialog</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;outerwidth&#39;</span><span class="p">)))</span>
    <span class="nx">safebind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@model</span><span class="p">,</span> <span class="s1">&#39;change:outerheight&#39;</span><span class="p">,</span> <span class="nf">()-&gt;</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">dialog</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;outerheight&#39;</span><span class="p">)))</span>

<span class="k">class</span> <span class="nx">DeferredView</span> <span class="k">extends</span> <span class="nx">ContinuumView</span>
  <span class="nv">initialize : </span><span class="nf">(options) -&gt;</span>
    <span class="vi">@deferred_parent = </span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;deferred_parent&#39;</span><span class="p">]</span>
    <span class="nx">@request_render</span><span class="p">()</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>

  <span class="nv">render : </span><span class="nf">() -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@_dirty = </span><span class="kc">false</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">request_render : </span><span class="nf">() -&gt;</span>
    <span class="vi">@_dirty = </span><span class="kc">true</span>

  <span class="nv">render_deferred_components : </span><span class="nf">(force) -&gt;</span>
    <span class="k">if</span> <span class="nx">force</span> <span class="o">or</span> <span class="nx">@_dirty</span>
      <span class="nx">@render</span><span class="p">()</span>

<span class="k">class</span> <span class="nx">DeferredParent</span> <span class="k">extends</span> <span class="nx">DeferredView</span>
  <span class="nv">initialize : </span><span class="nf">(options) -&gt;</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;render_loop&#39;</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;loop&#39;</span><span class="p">)</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">@render_loop</span><span class="p">())</span>
    <span class="nx">safebind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@model</span><span class="p">,</span> <span class="s1">&#39;change:render_loop&#39;</span><span class="p">,</span>
        <span class="p">()</span> <span class="o">=&gt;</span>
          <span class="k">if</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;render_loop&#39;</span><span class="p">)</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@looping</span>
            <span class="nx">@render_loop</span><span class="p">()</span>
    <span class="p">)</span>

  <span class="nv">render_loop : </span><span class="nf">() -&gt;</span>
    <span class="vi">@looping = </span><span class="kc">true</span>
    <span class="nx">@render_deferred_components</span><span class="p">()</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@removed</span> <span class="o">and</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;render_loop&#39;</span><span class="p">)</span>
      <span class="nx">setTimeout</span><span class="p">((()</span> <span class="o">=&gt;</span> <span class="nx">@render_loop</span><span class="p">()),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="vi">@looping = </span><span class="kc">false</span>

  <span class="nv">remove : </span><span class="nf">() -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@removed = </span><span class="kc">true</span>


<span class="nv">Continuum.DeferredView = </span><span class="nx">DeferredView</span>
<span class="nv">Continuum.DeferredParent = </span><span class="nx">DeferredParent</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>hasparent
display<em>options can be passed down to children
defaults for display</em>options should be placed
in a class var display_defaults
the get function, will resolve an instances defaults first
then check the parents actual val, and finally check class defaults.
display options cannot go into defaults</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>defaults vs display_defaults
backbone already has a system for attribute defaults, however we wanted to
impose a secondary inheritance system for attributes based on GUI hierarchies
the idea being that you generally want to inherit UI attributes from
your container/parent.  Here is how we do this.
HasParent models can have a parent attribute, which is our
continuum reference.  when we try to get an attribute, first we try to
get the attribute via super (so try properties, and if not that, normal
backbone resolution) if that results in something which is undefined,
then try to grab the attribute from the parent.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>the reason why we need to segregate display_defaults into a separate object
form backbones normal default is because backbone defaults are automatically
set on the object, so you have no way of knowing whether the attr exists
because it was a default, or whether it was intentionally set.  In the
parent case, we want to try parent settings BEFORE we rely on
display defaults.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>functionally, since this is mostly there to facilitate deferred lookups,
perhaps a name besides display_defaults would be appropriate, we might want
to store non-display related defaults here.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">HasParent</span> <span class="k">extends</span> <span class="nx">HasProperties</span>
  <span class="nv">get_fallback : </span><span class="nf">(attr) -&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">@get_ref</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span> <span class="o">and</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">@get_ref</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">).</span><span class="nx">parent_properties</span><span class="p">,</span> <span class="nx">attr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">and</span>
        <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">@get_ref</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">attr</span><span class="p">)))</span>
      <span class="k">return</span> <span class="nx">@get_ref</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">retval = </span><span class="nx">@display_defaults</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>this is ugly, we should take this out and not support object specs
in defaults</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="o">and</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">retval</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="nv">attrs = </span><span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">retval</span><span class="p">,</span> <span class="s1">&#39;attrs&#39;</span><span class="p">)</span> <span class="k">then</span> <span class="nx">retval</span><span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="nv">retval = </span> <span class="nx">@collections</span><span class="p">[</span><span class="nx">retval</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]].</span><span class="nx">create</span><span class="p">(</span><span class="nx">attrs</span><span class="p">).</span><span class="nx">ref</span><span class="p">()</span>
        <span class="nx">@set</span><span class="p">(</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">retval</span><span class="p">)</span>
        <span class="nx">@save</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">retval</span>

  <span class="nv">get : </span><span class="nf">(attr) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <h1>no fallback for 'parent'</h1>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">normalval = </span><span class="k">super</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">normalval</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">normalval</span>
    <span class="k">else</span> <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">attr</span> <span class="o">==</span> <span class="s1">&#39;parent&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">@get_fallback</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span>

  <span class="nv">display_defaults : </span><span class="p">{}</span>


<span class="k">class</span> <span class="nx">Component</span> <span class="k">extends</span> <span class="nx">HasParent</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>component class, has height, width, outerheight, outerwidth, and offsets.
components understand positioning themselves within other components, as well
as positioning any children that are inside them</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">collections : </span><span class="nx">Collections</span>
  <span class="nv">position_object_x : </span><span class="nf">(offset, container_width, object_width) -&gt;</span>
    <span class="k">return</span> <span class="nx">offset</span>
  <span class="nv">position_object_y : </span><span class="nf">(offset, container_height, object_height) -&gt;</span>
    <span class="k">return</span> <span class="nx">container_height</span> <span class="o">-</span> <span class="nx">object_height</span> <span class="o">-</span> <span class="nx">offset</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>transform our coordinate space to the underlying device (svg)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">xpos : </span><span class="nf">(x) -&gt;</span>
    <span class="k">return</span> <span class="nx">x</span>
  <span class="nv">ypos : </span><span class="nf">(y) -&gt;</span>
    <span class="k">return</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="nx">y</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>transform underlying device (svg) to our coordinate space</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rxpos : </span><span class="nf">(x) -&gt;</span>
    <span class="k">return</span> <span class="nx">x</span>

  <span class="nv">rypos : </span><span class="nf">(y) -&gt;</span>
    <span class="k">return</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="nx">y</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>compute a child components position in the underlying device</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">position_child_x : </span><span class="nf">(size, offset) -&gt;</span>
    <span class="k">return</span>  <span class="nx">@xpos</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span>
  <span class="nv">position_child_y : </span><span class="nf">(size, offset) -&gt;</span>
    <span class="k">return</span> <span class="nx">@ypos</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="o">-</span> <span class="nx">size</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>reverse a child components position to the equivalent offset</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">child_position_to_offset_x : </span><span class="nf">(child, position) -&gt;</span>
    <span class="nv">offset = </span><span class="nx">position</span>
    <span class="k">return</span> <span class="nx">@rxpos</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span>

  <span class="nv">child_position_to_offset_y : </span><span class="nf">(child, position) -&gt;</span>
    <span class="nv">offset = </span><span class="nx">position</span> <span class="o">+</span> <span class="nx">child</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;outerheight&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">@rypos</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>compute your position in the underlying device</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">position_x : </span><span class="o">-&gt;</span>
    <span class="nv">parent = </span><span class="nx">@get_ref</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">parent</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">position_child_x</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;outerwidth&#39;</span><span class="p">),</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

  <span class="nv">position_y : </span><span class="o">-&gt;</span>
    <span class="nv">parent = </span><span class="nx">@get_ref</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">parent</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="nv">val = </span><span class="nx">parent</span><span class="p">.</span><span class="nx">position_child_y</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;outerheight&#39;</span><span class="p">),</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="nx">val</span>

  <span class="nv">reverse_position_x : </span><span class="nf">(input) -&gt;</span>
    <span class="nv">parent = </span><span class="nx">@get_ref</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">parent</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">child_position_to_offset_x</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span>

  <span class="nv">reverse_position_y : </span><span class="nf">(input) -&gt;</span>
    <span class="nv">parent = </span><span class="nx">@get_ref</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">parent</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">child_position_to_offset_y</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span>

  <span class="nv">dinitialize : </span><span class="nf">(attrs, options) -&gt;</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="nx">@register_property</span><span class="p">(</span><span class="s1">&#39;outerwidth&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;border_space&#39;</span><span class="p">],</span>
      <span class="nf">() -&gt;</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;border_space&#39;</span><span class="p">)</span>
      <span class="kc">false</span><span class="p">)</span>
    <span class="nx">@register_property</span><span class="p">(</span><span class="s1">&#39;outerheight&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;border_space&#39;</span><span class="p">],</span>
      <span class="nf">() -&gt;</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;border_space&#39;</span><span class="p">)</span>
      <span class="kc">false</span><span class="p">)</span>

  <span class="nv">defaults :</span>
    <span class="nv">parent : </span><span class="kc">null</span>

  <span class="nv">display_defaults:</span>
    <span class="nv">width : </span><span class="mi">200</span>
    <span class="nv">height : </span><span class="mi">200</span>
    <span class="nv">position : </span><span class="mi">0</span>
    <span class="nv">offset : </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">border_space : </span><span class="mi">30</span>

  <span class="nv">default_view : </span><span class="kc">null</span>

<span class="k">class</span> <span class="nx">DataTableView</span> <span class="k">extends</span> <span class="nx">ContinuumView</span>
  <span class="nv">initialize : </span><span class="nf">(options) -&gt;</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
    <span class="nx">@render</span><span class="p">()</span>
    <span class="nx">safebind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@model</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">@render</span><span class="p">)</span>


  <span class="nv">render : </span><span class="nf">() -&gt;</span>
    <span class="nv">table_template = </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;div class=&#39;table&#39; id=&#39;{{ tableid }}&#39;&gt;</span>
<span class="s2">    &lt;/div&gt;</span>

<span class="s2">    &quot;&quot;&quot;</span>
    <span class="nv">header_template = </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      &lt;div class=&#39;headerrow&#39; id = &#39;{{headerrowid}}&#39;&gt;</span>
<span class="s2">      &lt;/div&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="nv">header_column = </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      &lt;div class=&#39;header&#39;&gt;</span>
<span class="s2">        {{column_name}}</span>
<span class="s2">      &lt;/div&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nv">row_template = </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      &lt;div class=&#39;datarow&#39;&gt;</span>
<span class="s2">      &lt;/div&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="nv">datacell_template = </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      &lt;div class=&#39;datacell&#39;&gt; {{ data}} &lt;/div&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="nv">header_html = </span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">header_template</span><span class="p">,</span>
      <span class="p">{</span><span class="s1">&#39;headerrowid&#39;</span> <span class="o">:</span> <span class="nx">@tag_id</span><span class="p">(</span><span class="s1">&#39;headerrow&#39;</span><span class="p">)})</span>
    <span class="nv">header = </span><span class="nx">$</span><span class="p">(</span><span class="nx">header_html</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">colname</span> <span class="k">in</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
      <span class="nv">html = </span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">header_column</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;column_name&#39;</span> <span class="o">:</span> <span class="nx">colname</span><span class="p">})</span>
      <span class="nx">header</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">html</span><span class="p">))</span>
    <span class="nv">table = </span><span class="nx">$</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">table_template</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;tableid&#39;</span> <span class="o">:</span> <span class="nx">@tag_id</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)}))</span>
    <span class="nx">table</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">rowdata</span> <span class="k">in</span> <span class="nx">@mget_ref</span><span class="p">(</span><span class="s1">&#39;data_source&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
      <span class="nv">row = </span><span class="nx">$</span><span class="p">(</span><span class="nx">row_template</span><span class="p">)</span>
      <span class="k">for</span> <span class="nx">colname</span> <span class="k">in</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
        <span class="nv">datacell = </span><span class="nx">$</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">datacell_template</span><span class="p">,</span>
          <span class="p">{</span><span class="s1">&#39;data&#39;</span> <span class="o">:</span> <span class="nx">rowdata</span><span class="p">[</span><span class="nx">colname</span><span class="p">]}))</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">datacell</span><span class="p">)</span>
        <span class="nx">table</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">row</span><span class="p">)</span>
    <span class="nx">@$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">table</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;usedialog&#39;</span><span class="p">)</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@$el</span><span class="p">.</span><span class="o">is</span><span class="p">(</span><span class="s2">&quot;:visible&quot;</span><span class="p">)</span>
      <span class="nx">@add_dialog</span><span class="p">()</span>

<span class="k">class</span> <span class="nx">DataTable</span> <span class="k">extends</span> <span class="nx">Component</span>
  <span class="nv">type : </span><span class="s1">&#39;DataTable&#39;</span>
  <span class="nv">default_view : </span><span class="nx">DataTableView</span>
  <span class="nv">defaults :</span>
    <span class="nv">data_source : </span><span class="kc">null</span>
    <span class="nv">columns : </span><span class="p">[]</span>

<span class="k">class</span> <span class="nx">DataTables</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span>
  <span class="nv">model : </span><span class="nx">DataTable</span>

<span class="k">class</span> <span class="nx">TableView</span> <span class="k">extends</span> <span class="nx">ContinuumView</span>
  <span class="nv">delegateEvents: </span><span class="o">-&gt;</span>
    <span class="nx">safebind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@model</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="nx">@remove</span><span class="p">)</span>
    <span class="nx">safebind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@model</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">@request_render</span><span class="p">)</span>

  <span class="nv">render : </span><span class="o">-&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="nx">@$el</span><span class="p">.</span><span class="nx">empty</span><span class="p">()</span>
    <span class="nx">@$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;table&gt;&lt;/table&gt;&quot;</span><span class="p">)</span>
    <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;tr&gt;&lt;/tr&gt;&quot;</span><span class="p">)</span>
    <span class="nv">headerrow = </span><span class="nx">$</span><span class="p">(</span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="nx">column</span><span class="p">,</span> <span class="nx">idx</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">))</span>
      <span class="nv">elem = </span><span class="nx">$</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="s1">&#39;&lt;th class=&quot;tableelem tableheader&quot;&gt;{{ name }}&lt;/th&gt;&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="o">:</span> <span class="nx">column</span><span class="p">}))</span>
      <span class="nx">headerrow</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">idx</span> <span class="k">in</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
      <span class="nv">row_elem = </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;tr class=&#39;tablerow&#39;&gt;&lt;/tr&gt;&quot;</span><span class="p">)</span>
      <span class="nv">rownum = </span><span class="nx">idx</span> <span class="o">+</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;data_slice&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">data</span> <span class="k">in</span> <span class="p">[</span><span class="nx">rownum</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">row</span><span class="p">)</span>
        <span class="nv">elem = </span><span class="nx">$</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="s2">&quot;&lt;td class=&#39;tableelem&#39;&gt;{{val}}&lt;/td&gt;&quot;</span><span class="p">,</span>
          <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="o">:</span><span class="nx">data</span><span class="p">}))</span>
        <span class="nx">row_elem</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">row_elem</span><span class="p">)</span>
    <span class="nx">@render_pagination</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;usedialog&#39;</span><span class="p">)</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@$el</span><span class="p">.</span><span class="o">is</span><span class="p">(</span><span class="s2">&quot;:visible&quot;</span><span class="p">)</span>
      <span class="nx">@add_dialog</span><span class="p">()</span>

  <span class="nv">render_pagination : </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">node = </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;button&gt;first&lt;/button&gt;&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;cursor&#39;</span> <span class="o">:</span> <span class="s1">&#39;pointer&#39;</span><span class="p">})</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="o">=&gt;</span>
        <span class="nx">@model</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">false</span>
      <span class="p">)</span>
      <span class="nv">node = </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;button&gt;previous&lt;/button&gt;&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;cursor&#39;</span> <span class="o">:</span> <span class="s1">&#39;pointer&#39;</span><span class="p">})</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="o">=&gt;</span>
        <span class="nx">@model</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">([</span><span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;chunksize&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="kc">false</span>
      <span class="p">)</span>

    <span class="nv">maxoffset = </span><span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;total_rows&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;chunksize&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">maxoffset</span>
      <span class="nv">node = </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;button&gt;next&lt;/button&gt;&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;cursor&#39;</span> <span class="o">:</span> <span class="s1">&#39;pointer&#39;</span><span class="p">})</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="o">=&gt;</span>
        <span class="nx">@model</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">([</span>
          <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;chunksize&#39;</span><span class="p">),</span>
          <span class="nx">maxoffset</span><span class="p">]))</span>
        <span class="k">return</span> <span class="kc">false</span>
      <span class="p">)</span>
      <span class="nv">node = </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;button&gt;last&lt;/button&gt;&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;cursor&#39;</span> <span class="o">:</span> <span class="s1">&#39;pointer&#39;</span><span class="p">})</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="o">=&gt;</span>
        <span class="nx">@model</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">maxoffset</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">false</span>
      <span class="p">)</span>


<span class="k">class</span> <span class="nx">Table</span> <span class="k">extends</span> <span class="nx">Component</span>
  <span class="nv">type : </span><span class="s1">&#39;Table&#39;</span>
  <span class="nv">dinitialize : </span><span class="nf">(attrs, options)-&gt;</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="nx">@register_property</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;data_slice&#39;</span><span class="p">],</span>
      <span class="p">(</span><span class="nf">() -&gt;</span> <span class="k">return</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;data_slice&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="kc">false</span>
    <span class="p">)</span>
    <span class="nx">@register_property</span><span class="p">(</span><span class="s1">&#39;chunksize&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;data_slice&#39;</span><span class="p">],</span>
      <span class="p">(</span><span class="nf">() -&gt;</span> <span class="k">return</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;data_slice&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;data_slice&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
      <span class="kc">false</span>
    <span class="p">)</span>

  <span class="nv">defaults :</span>
    <span class="nv">url : </span><span class="s2">&quot;&quot;</span>
    <span class="nv">columns : </span><span class="p">[]</span>
    <span class="nv">data : </span><span class="p">[[]]</span>
    <span class="nv">data_slice : </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
    <span class="nv">total_rows : </span><span class="mi">0</span>
  <span class="nv">default_view : </span><span class="nx">TableView</span>
  <span class="nv">load : </span><span class="nf">(offset) -&gt;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">),</span>
        <span class="nv">data_slice : </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;data_slice&#39;</span><span class="p">))</span>
      <span class="p">,</span>
        <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;data_slice&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">offset</span> <span class="o">+</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;chunksize&#39;</span><span class="p">)],</span>
            <span class="p">{</span><span class="nx">silent</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
          <span class="nx">@set</span><span class="p">({</span><span class="s1">&#39;data&#39;</span> <span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)[</span><span class="s1">&#39;data&#39;</span><span class="p">]})</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nx">Tables</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span>
  <span class="nv">model : </span><span class="nx">Table</span>
  <span class="nv">url : </span><span class="s2">&quot;/bb&quot;</span>

<span class="k">class</span> <span class="nx">InteractiveContextView</span> <span class="k">extends</span> <span class="nx">DeferredParent</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Interactive context keeps track of a bunch of components that we render
into dialogs</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">initialize : </span><span class="nf">(options) -&gt;</span>
    <span class="vi">@views = </span><span class="p">{}</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>

  <span class="nv">delegateEvents: </span><span class="o">-&gt;</span>
    <span class="nx">safebind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@model</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="nx">@remove</span><span class="p">)</span>
    <span class="nx">safebind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@model</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">@request_render</span><span class="p">)</span>

  <span class="nv">generate_remove_child_callback : </span><span class="nf">(view) -&gt;</span>
    <span class="nv">callback = </span><span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nv">newchildren = </span><span class="p">(</span><span class="nx">x</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">)</span> <span class="k">when</span> <span class="nx">x</span><span class="p">.</span><span class="nx">id</span> <span class="o">!=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
      <span class="nx">@mset</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="nx">newchildren</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">null</span>
    <span class="k">return</span> <span class="nx">callback</span>

  <span class="nv">build_children : </span><span class="nf">() -&gt;</span>
    <span class="k">for</span> <span class="nx">spec</span> <span class="k">in</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">)</span>
      <span class="nv">model = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">resolve_ref</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span>
      <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="s1">&#39;usedialog&#39;</span> <span class="o">:</span> <span class="kc">true</span><span class="p">})</span>
    <span class="nv">created_views = </span><span class="nx">build_views</span><span class="p">(</span><span class="nx">@model</span><span class="p">,</span> <span class="nx">@views</span><span class="p">,</span> <span class="nx">@mget</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="nx">view</span> <span class="k">in</span> <span class="nx">created_views</span>
      <span class="nx">safebind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">view</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="nx">@generate_remove_child_callback</span><span class="p">(</span><span class="nx">view</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">null</span>

  <span class="nv">render_deferred_components : </span><span class="nf">(force) -&gt;</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">force</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">view</span> <span class="k">in</span> <span class="nx">_</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">@views</span><span class="p">)</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">render_deferred_components</span><span class="p">(</span><span class="nx">force</span><span class="p">)</span>

  <span class="nv">render : </span><span class="nf">() -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="nx">@build_children</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">null</span>

<span class="k">class</span> <span class="nx">InteractiveContext</span> <span class="k">extends</span> <span class="nx">Component</span>
  <span class="nv">type : </span><span class="s1">&#39;InteractiveContext&#39;</span><span class="p">,</span>
  <span class="nv">default_view : </span><span class="nx">InteractiveContextView</span>
  <span class="nv">defaults :</span>
    <span class="nv">children : </span><span class="p">[]</span>
    <span class="nv">width : </span><span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
    <span class="nv">height : </span><span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">();</span>
    <span class="nv">render_loop : </span><span class="kc">true</span>
<span class="k">class</span> <span class="nx">InteractiveContexts</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span>
  <span class="nv">model : </span><span class="nx">InteractiveContext</span>
<span class="nx">Continuum</span><span class="p">.</span><span class="nx">register_collection</span><span class="p">(</span><span class="s1">&#39;Table&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Tables</span><span class="p">())</span>
<span class="nx">Continuum</span><span class="p">.</span><span class="nx">register_collection</span><span class="p">(</span><span class="s1">&#39;InteractiveContext&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">InteractiveContexts</span><span class="p">())</span>
<span class="nx">Continuum</span><span class="p">.</span><span class="nx">register_collection</span><span class="p">(</span><span class="s1">&#39;DataTable&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">DataTables</span><span class="p">())</span>

<span class="nv">Continuum.ContinuumView = </span><span class="nx">ContinuumView</span>
<span class="nv">Continuum.HasProperties = </span><span class="nx">HasProperties</span>
<span class="nv">Continuum.HasParent = </span><span class="nx">HasParent</span>
<span class="nv">Continuum.Component = </span><span class="nx">Component</span>
<span class="nv">Continuum.safebind = </span><span class="nx">safebind</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 